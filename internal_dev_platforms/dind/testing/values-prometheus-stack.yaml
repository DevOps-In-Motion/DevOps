# kube-prometheus-stack: Prometheus + wiki-api ServiceMonitor.
# Chart expects prometheus.enabled (default true); prometheusSpec.additionalServiceMonitors creates the ServiceMonitor.
prometheus:
  enabled: true
  create: true
  port: 9113
  secret: ""
  scheme: http
  service:
    create: true
  serviceMonitor:
    create: true
    labels:
      app: nginx-ingress-servicemonitor
  prometheusSpec:
    # So Prometheus selects ServiceMonitors created from additionalServiceMonitors (they get release labels from the chart).
    serviceMonitorSelectorNilUsesHelmValues: true
    # Scrape wiki-api from test-wiki-stack.yaml (Service wiki-api-service in default ns must have label app: wiki-api).
    additionalServiceMonitors:
      - name: wiki-api-servicemonitor
        jobLabel: app
        selector:
          matchLabels:
            app: wiki-api
        namespaceSelector:
          matchNames:
            - default
        endpoints:
          - port: http
            path: /metrics
            interval: 30s

# kube-prometheus-stack Grafana config (creation dashboard = users/posts rate, uid creation-dashboard-678, path /d/creation-dashboard-678/creation)
grafana:
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
      searchNamespace: ALL
      
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: o11y-prometheus
        type: prometheus
        url: http://prometheus:9090
        uid: o11y-prometheus
        # Access mode - proxy (server in the UI) or direct (browser in the UI).
        access: proxy
        isDefault: true

  dashboards:
    default:
      creation-dashboard:
        json: |
          {
            "annotations": { "list": [] },
            "editable": true,
            "fiscalYearStartMonth": 0,
            "graphTooltip": 0,
            "id": null,
            "links": [],
            "liveNow": false,
            "panels": [
              {
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "fieldConfig": {
                  "defaults": {
                    "color": { "mode": "palette-classic" },
                    "custom": {
                      "axisCenteredZero": false,
                      "axisLabel": "",
                      "axisPlacement": "auto",
                      "drawStyle": "line",
                      "fillOpacity": 10,
                      "gradientMode": "none",
                      "hideFrom": { "legend": false, "tooltip": false, "viz": false },
                      "lineInterpolation": "linear",
                      "lineWidth": 1,
                      "pointSize": 5,
                      "scaleDistribution": { "type": "linear" },
                      "showPoints": "auto",
                      "spanNulls": false,
                      "stacking": { "group": "A", "mode": "none" },
                      "thresholdsStyle": { "mode": "off" }
                    },
                    "mappings": [],
                    "thresholds": {
                      "mode": "absolute",
                      "steps": [
                        { "color": "green", "value": null },
                        { "color": "red", "value": 80 }
                      ]
                    },
                    "unit": "short"
                  },
                  "overrides": []
                },
                "gridPos": { "h": 8, "w": 24, "x": 0, "y": 0 },
                "id": 1,
                "options": {
                  "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true }
                },
                "targets": [
                  {
                    "datasource": { "type": "prometheus", "uid": "prometheus" },
                    "editorMode": "code",
                    "expr": "rate(users_created_total[5m])",
                    "legendFormat": "Users created (rate)",
                    "range": true,
                    "refId": "A"
                  },
                  {
                    "datasource": { "type": "prometheus", "uid": "prometheus" },
                    "editorMode": "code",
                    "expr": "rate(posts_created_total[5m])",
                    "legendFormat": "Posts created (rate)",
                    "hide": false,
                    "range": true,
                    "refId": "B"
                  }
                ],
                "title": "Users and posts creation rate",
                "type": "timeseries"
              }
            ],
            "refresh": "10s",
            "schemaVersion": 38,
            "style": "dark",
            "tags": ["wiki", "creation"],
            "templating": { "list": [] },
            "time": { "from": "now-1h", "to": "now" },
            "timepicker": {},
            "timezone": "",
            "title": "creation",
            "uid": "creation-dashboard-678",
            "version": 1,
            "weekStart": ""
          }