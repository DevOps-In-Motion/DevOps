# k3d cluster config for wiki stack. Used by entrypoint: k3d cluster create --config /app/k3d/config.yaml
# For data persistence (Option 1): run with -v wiki-data:/data and uncomment the volumes block below.
apiVersion: k3d.io/v1alpha5
kind: Simple

metadata:
  name: wiki

servers: 1
agents: 1

image: rancher/k3s:latest

kubeAPI:
  hostIP: "0.0.0.0"
  hostPort: "6550"

ports:
  - port: 8080:80
    nodeFilters:
      - loadbalancer
  - port: 3000:80
    nodeFilters:
      - loadbalancer
  - port: 9090:80
    nodeFilters:
      - loadbalancer
  - port: 8443:443
    nodeFilters:
      - loadbalancer

# Optional: uncomment to mount Postgres data into nodes (requires -v wiki-data:/data when running DinD).
# volumes:
#   - volume: /data/wiki-postgres:/mnt/data/wiki-backend-postgresql
#     nodeFilters:
#       - server:*
#       - agent:*

# HelmChartConfig so Traefik watches monitoring namespace (Grafana Ingress). K3s applies any file in
# /var/lib/rancher/k3s/server/manifests/ and merges HelmChartConfig with the built-in Traefik HelmChart.
# See: https://docs.k3s.io/helm#customizing-packaged-components-with-helmchartconfig
files:
  - destination: /var/lib/rancher/k3s/server/manifests/traefik-helmconfig.yaml
    nodeFilters:
      - server:*
    source: |
      apiVersion: helm.cattle.io/v1
      kind: HelmChartConfig
      metadata:
        name: traefik
        namespace: kube-system
      spec:
        valuesContent: |-
          additionalArguments:
            - "--providers.kubernetesingress.namespaces=default,monitoring,kube-system"

options:
  k3d:
    wait: true
    timeout: "300s"
  runtime:
    serversMemory: "10g"
